<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8">
<title>مدیریت ابزار در گردش</title>
<style>
    @font-face {
        font-family: "B Nazanin";
        src: url("/static/fonts/B-NAZANIN.TTF") format("truetype");
    }
    body {
        font-family: "B Nazanin", Arial, sans-serif;
        direction: rtl;
        background: #f4f7fb;
        margin: 20px;
    }
    h1 { text-align:center; color:#003366; margin-bottom:14px; }
    form.search-form, form.add-form {
        background:#fff; padding:10px; border-radius:10px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.04);
        display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap;
    }
    input[type="text"], select, input[type="file"] {
        padding:7px; border-radius:8px; border:1px solid #c6d0da; font-family:"B Nazanin"; font-size:13px;
    }
    button {
        background: linear-gradient(180deg,#2196F3,#0b7dda);
        color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:bold;
        box-shadow: 0 6px 12px rgba(11,125,218,0.18);
    }
    button.small {
        padding:6px 8px; font-size:13px;
    }
    table {
        width:100%; border-collapse:collapse; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.04);
        font-size:13px; /* محتوای جدول کمی کوچکتر */
    }
    th {
        background:#007BFF; color:#fff; padding:8px; text-align:center;
    }
    td {
        padding:8px; text-align:center; border-bottom:1px solid #eef2f8; font-weight:bold;
    }
    td.thread { font-size:12px; width:110px; } /* ستون نوع رزوه کوچک‌تر و باریک‌تر */
    td.description { width:320px; } /* شرح پهن‌تر */
    .actions { display:flex; gap:6px; justify-content:center; }
    .actions a button { display:inline-block; }
    .desc-input {
        width:95%; padding:6px; border-radius:6px; border:1px solid #cfd8e3; font-family:"B Nazanin"; font-size:13px;
    }
    .button-link { text-decoration:none; }
</style>
</head>
<body>
    <h1>🛠 مدیریت ابزار در گردش</h1>

    <!-- فرم جستجو -->
    <form class="search-form" method="GET" action="/">
        <label>نوع ابزار:</label>
        <select name="tool_type">
            <option value="">همه</option>
            <option {% raw %}{% if filters.tool_type == 'PUP Joint' %}selected{% endif %}{% endraw %}>PUP Joint</option>
            <option {% raw %}{% if filters.tool_type == 'Fishing' %}selected{% endif %}{% endraw %}>Fishing</option>
            <option {% raw %}{% if filters.tool_type == 'Drill Pipe' %}selected{% endif %}{% endraw %}>Drill Pipe</option>
            <option {% raw %}{% if filters.tool_type == 'Drill Collar' %}selected{% endif %}{% endraw %}>Drill Collar</option>
            <option {% raw %}{% if filters.tool_type == 'HW' %}selected{% endif %}{% endraw %}>HW</option>
            <option {% raw %}{% if filters.tool_type == 'Bit Sub' %}selected{% endif %}{% endraw %}>Bit Sub</option>
        </select>

        <label>شماره سریال:</label>
        <input type="text" name="serial_number" value="{{ filters.serial_number }}">

        <label>وضعیت:</label>
        <select name="status">
            <option value="">همه</option>
            <option {% raw %}{% if filters.status == 'Ready to Use' %}selected{% endif %}{% endraw %}>Ready to Use</option>
            <option {% raw %}{% if filters.status == 'Need to Repair' %}selected{% endif %}{% endraw %}>Need to Repair</option>
            <option {% raw %}{% if filters.status == 'Need to Sandblast' %}selected{% endif %}{% endraw %}>Need to Sandblast</option>
            <option {% raw %}{% if filters.status == 'Scrap' %}selected{% endif %}{% endraw %}>Scrap</option>
            <option {% raw %}{% if filters.status == 'Class 2' %}selected{% endif %}{% endraw %}>Class 2</option>
            <option {% raw %}{% if filters.status == 'Need to Inspection' %}selected{% endif %}{% endraw %}>Need to Inspection</option>
        </select>

        <label>محل نگهداری:</label>
        <input type="text" name="location" value="{{ filters.location }}" placeholder="متن وارد کنید">

        <button type="submit">🔍 جستجو</button>
        <a href="/"><button type="button">نمایش همه</button></a>
    </form>

    <!-- فرم ثبت دستی -->
    <form class="add-form" method="POST" action="/add" enctype="multipart/form-data">
        <input type="text" name="tool_type" placeholder="نوع ابزار (یا از کرکره انتخاب کن)">
        <select name="tool_type_select">
            <option value="">انتخاب نوع...</option>
            <option>PUP Joint</option>
            <option>Fishing</option>
            <option>Drill Pipe</option>
            <option>Drill Collar</option>
            <option>HW</option>
            <option>Bit Sub</option>
        </select>

        <input type="text" name="serial_number" placeholder="شماره سریال">
        <input type="text" name="size" placeholder="سایز">
        <input type="text" name="thread_type" placeholder="نوع رزوه">
        <input type="text" name="location" placeholder="محل نگهداری">

        <select name="status">
            <option>Ready to Use</option>
            <option>Need to Repair</option>
            <option>Need to Sandblast</option>
            <option>Scrap</option>
            <option>Class 2</option>
            <option>Need to Inspection</option>
        </select>

        گزارش: <input type="file" name="report_file" accept=".pdf">
        توضیحات: <input type="text" name="description" placeholder="توضیحات (اختیاری)">

        <button type="submit">➕ ثبت ابزار</button>
    </form>

    <!-- آپلود اکسل -->
    <form style="margin-bottom:14px;" method="POST" action="/upload_excel" enctype="multipart/form-data">
        <input type="file" name="excel_file" accept=".xlsx">
        <button type="submit">📤 بارگذاری فایل Excel</button>
    </form>

    <!-- جدول -->
    <table>
        <thead>
            <tr>
                <th style="width:60px;">ID</th>
                <th>نوع ابزار</th>
                <th>شماره سریال</th>
                <th>سایز</th>
                <th style="width:110px;">نوع رزوه</th>
                <th>محل نگهداری</th>
                <th>وضعیت</th>
                <th style="width:140px;">عملیات</th>
                <th style="width:320px;">شرح / توضیحات</th>
            </tr>
        </thead>
        <tbody>
            {% raw %}{% for tool in tools %}{% endraw %}
            <tr>
                <td>{{ tool['id']|en_digits }}</td>
                <td>{{ tool['tool_type'] }}</td>
                <td>{{ tool['serial_number']|en_digits }}</td>
                <td>{{ tool['size']|en_digits }}</td>
                <td class="thread">{{ tool['thread_type'] }}</td>
                <td>{{ tool['location'] }}</td>
                <td>{{ tool['status'] }}</td>
                <td class="actions">
                    <a class="button-link" href="{{ url_for('edit', id=tool['id']) }}"><button class="small">✏️ ویرایش</button></a>
                    <a class="button-link" href="{{ url_for('delete', id=tool['id']) }}" onclick="return confirm('آیا مطمئن هستید؟')"><button class="small" style="background:linear-gradient(180deg,#ff5c5c,#c82323);">🗑 حذف</button></a>
                </td>
                <td class="description">
                    <!-- input ذخیره خودکار روی blur -->
                    <input class="desc-input" 
                           data-id="{{ tool['id'] }}" 
                           type="text" 
                           name="description" 
                           value="{{ tool['description'] or '' }}" 
                           placeholder="توضیحات...">
                </td>
            </tr>
            {% raw %}{% endfor %}{% endraw %}
        </tbody>
    </table>

<script>
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.desc-input').forEach(function(inp){
        inp.addEventListener('blur', function(){
            const id = this.getAttribute('data-id');
            const value = this.value;
            fetch('/update_description/' + id, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description: value })
            }).then(function(resp){
                if(!resp.ok){
                    console.error('خطا در ذخیره‌سازی توضیحات.');
                }
            }).catch(function(err){
                console.error('خطا در ارسال:', err);
            });
        });
    });
});
</script>
</body>
</html>
