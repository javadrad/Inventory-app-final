<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>مدیریت ابزار در گردش</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        table {
            font-size: 13px;
        }
        th:nth-child(5) { width: 100px; } /* نوع رزوه کوچکتر */
        th:nth-child(9) { width: 220px; } /* ستون شرح کمی عریض‌تر */
        input[type="text"], select {
            font-size: 13px;
        }
        .action-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <h1>مدیریت ابزار در گردش</h1>

    <form method="GET" action="/">
        <div class="search-container">
            <label>نوع ابزار:</label>
            <select name="tool_type">
                <option value="">همه</option>
                <option value="Drill Pipe">Drill Pipe</option>
                <option value="Cross Over Sub">Cross Over Sub</option>
                <option value="Short Sub">Short Sub</option>
                <option value="Casing Scrapper">Casing Scrapper</option>
                <option value="Double Box">Double Box</option>
            </select>

            <label>شماره سریال:</label>
            <input type="text" name="serial_number">

            <label>وضعیت:</label>
            <select name="status">
                <option value="">همه</option>
                <option value="In Use">In Use</option>
                <option value="Idle">Idle</option>
                <option value="Repair">Repair</option>
                <option value="Scrap">Scrap</option>
            </select>

            <label>محل نگهداری:</label>
            <input type="text" name="location">

            <button type="submit" class="btn">جستجو</button>

            <div class="action-buttons">
                <button type="button" class="btn delete-selected" onclick="deleteSelected()">حذف موردی</button>
                <button type="button" class="btn delete-all" onclick="deleteAllFiltered()">حذف همه</button>
            </div>
        </div>
    </form>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">
          {% for msg in messages %}
            <p>{{ msg }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <table border="1" cellpadding="6" cellspacing="0">
        <thead>
            <tr>
                <th><input type="checkbox" id="checkAll"></th>
                <th>ID</th>
                <th>نوع ابزار</th>
                <th>شماره سریال</th>
                <th>سایز</th>
                <th>نوع رزوه</th>
                <th>محل نگهداری</th>
                <th>وضعیت</th>
                <th>شرح</th>
                <th>گزارش بازرسی</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody>
            {% for tool in tools %}
            <tr>
                <td><input type="checkbox" class="row-check" value="{{ tool.id }}"></td>
                <td>{{ tool.id }}</td>
                <td>{{ tool.tool_type }}</td>
                <td>{{ tool.serial_number }}</td>
                <td>{{ tool.size }}</td>
                <td>{{ tool.thread_type }}</td>
                <td>{{ tool.location }}</td>
                <td>{{ tool.status }}</td>
                <td contenteditable="true" onblur="autoSave(this, {{ tool.id }})">{{ tool.description or '' }}</td>
                <td>
                    {% if tool.report_link %}
                        <a href="{{ tool.report_link }}" target="_blank">مشاهده</a>
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td><a href="/delete/{{ tool.id }}" onclick="return confirm('آیا از حذف اطمینان دارید؟')">🗑</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        function autoSave(cell, id) {
            const value = cell.innerText;
            fetch(`/edit/${id}`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `field=description&value=${encodeURIComponent(value)}`
            });
        }

        document.getElementById('checkAll').addEventListener('change', function() {
            document.querySelectorAll('.row-check').forEach(ch => ch.checked = this.checked);
        });

        function deleteSelected() {
            const selected = Array.from(document.querySelectorAll('.row-check:checked')).map(ch => ch.value);
            if (selected.length === 0) {
                alert("هیچ موردی انتخاب نشده است.");
                return;
            }
            if (!confirm("آیا از حذف موارد انتخاب‌شده اطمینان دارید؟")) return;

            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/delete_selected";

            selected.forEach(id => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "ids";
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }

        function deleteAllFiltered() {
            if (!confirm("آیا از حذف همه موارد جستجو شده اطمینان دارید؟")) return;
            const form = document.querySelector("form");
            form.action = "/delete_all_filtered";
            form.method = "POST";
            form.submit();
        }
    </script>
</body>
</html>
