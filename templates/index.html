<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¨Ø²Ø§Ø± Ø¯Ø± Ú¯Ø±Ø¯Ø´</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        table {
            font-size: 13px;
        }
        th:nth-child(5) { width: 100px; } /* Ù†ÙˆØ¹ Ø±Ø²ÙˆÙ‡ Ú©ÙˆÚ†Ú©ØªØ± */
        th:nth-child(9) { width: 220px; } /* Ø³ØªÙˆÙ† Ø´Ø±Ø­ Ú©Ù…ÛŒ Ø¹Ø±ÛŒØ¶â€ŒØªØ± */
        input[type="text"], select {
            font-size: 13px;
        }
        .action-buttons {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¨Ø²Ø§Ø± Ø¯Ø± Ú¯Ø±Ø¯Ø´</h1>

    <form method="GET" action="/">
        <div class="search-container">
            <label>Ù†ÙˆØ¹ Ø§Ø¨Ø²Ø§Ø±:</label>
            <select name="tool_type">
                <option value="">Ù‡Ù…Ù‡</option>
                <option value="Drill Pipe">Drill Pipe</option>
                <option value="Cross Over Sub">Cross Over Sub</option>
                <option value="Short Sub">Short Sub</option>
                <option value="Casing Scrapper">Casing Scrapper</option>
                <option value="Double Box">Double Box</option>
            </select>

            <label>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„:</label>
            <input type="text" name="serial_number">

            <label>ÙˆØ¶Ø¹ÛŒØª:</label>
            <select name="status">
                <option value="">Ù‡Ù…Ù‡</option>
                <option value="In Use">In Use</option>
                <option value="Idle">Idle</option>
                <option value="Repair">Repair</option>
                <option value="Scrap">Scrap</option>
            </select>

            <label>Ù…Ø­Ù„ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ:</label>
            <input type="text" name="location">

            <button type="submit" class="btn">Ø¬Ø³ØªØ¬Ùˆ</button>

            <div class="action-buttons">
                <button type="button" class="btn delete-selected" onclick="deleteSelected()">Ø­Ø°Ù Ù…ÙˆØ±Ø¯ÛŒ</button>
                <button type="button" class="btn delete-all" onclick="deleteAllFiltered()">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
            </div>
        </div>
    </form>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">
          {% for msg in messages %}
            <p>{{ msg }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <table border="1" cellpadding="6" cellspacing="0">
        <thead>
            <tr>
                <th><input type="checkbox" id="checkAll"></th>
                <th>ID</th>
                <th>Ù†ÙˆØ¹ Ø§Ø¨Ø²Ø§Ø±</th>
                <th>Ø´Ù…Ø§Ø±Ù‡ Ø³Ø±ÛŒØ§Ù„</th>
                <th>Ø³Ø§ÛŒØ²</th>
                <th>Ù†ÙˆØ¹ Ø±Ø²ÙˆÙ‡</th>
                <th>Ù…Ø­Ù„ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ</th>
                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                <th>Ø´Ø±Ø­</th>
                <th>Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§Ø²Ø±Ø³ÛŒ</th>
                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
            </tr>
        </thead>
        <tbody>
            {% for tool in tools %}
            <tr>
                <td><input type="checkbox" class="row-check" value="{{ tool.id }}"></td>
                <td>{{ tool.id }}</td>
                <td>{{ tool.tool_type }}</td>
                <td>{{ tool.serial_number }}</td>
                <td>{{ tool.size }}</td>
                <td>{{ tool.thread_type }}</td>
                <td>{{ tool.location }}</td>
                <td>{{ tool.status }}</td>
                <td contenteditable="true" onblur="autoSave(this, {{ tool.id }})">{{ tool.description or '' }}</td>
                <td>
                    {% if tool.report_link %}
                        <a href="{{ tool.report_link }}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
                    {% else %}
                        â€”
                    {% endif %}
                </td>
                <td><a href="/delete/{{ tool.id }}" onclick="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')">ğŸ—‘</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        function autoSave(cell, id) {
            const value = cell.innerText;
            fetch(`/edit/${id}`, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `field=description&value=${encodeURIComponent(value)}`
            });
        }

        document.getElementById('checkAll').addEventListener('change', function() {
            document.querySelectorAll('.row-check').forEach(ch => ch.checked = this.checked);
        });

        function deleteSelected() {
            const selected = Array.from(document.querySelectorAll('.row-check:checked')).map(ch => ch.value);
            if (selected.length === 0) {
                alert("Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                return;
            }
            if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù…ÙˆØ§Ø±Ø¯ Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) return;

            const form = document.createElement("form");
            form.method = "POST";
            form.action = "/delete_selected";

            selected.forEach(id => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "ids";
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        }

        function deleteAllFiltered() {
            if (!confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯ Ø¬Ø³ØªØ¬Ùˆ Ø´Ø¯Ù‡ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ")) return;
            const form = document.querySelector("form");
            form.action = "/delete_all_filtered";
            form.method = "POST";
            form.submit();
        }
    </script>
</body>
</html>
